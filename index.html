<!DOCTYPE html>
<html lang="gl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Calculadora CAGED</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0a84ff" />
  <style>
    :root{
      --bg:#f5f6f7; --card:#ffffff; --text:#111114; --muted:#6e6e73; --accent:#0a84ff;
      --border:#d1d1d6; --control:#ffffff; --chip:#f2f2f7;
      --radius:14px; --shadow:0 6px 20px rgba(0,0,0,.08);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Text", Inter, Roboto, Segoe UI, sans-serif;
      --dropdown:#ffffff; --drop-border:#d1d1d6; --drop-shadow:0 10px 24px rgba(0,0,0,.14);
      --sheet-bg:#ffffff; --sheet-border:#d1d1d6; --backdrop: rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0b0c; --card:#161618; --text:#f2f2f7; --muted:#a1a1a6; --accent:#0a84ff;
        --border:#2e2e35; --control:#1d1d20; --chip:#1a1a1d;
        --shadow:none; --dropdown:#1e1e22; --drop-border:#2e2e35; --drop-shadow:0 10px 24px rgba(0,0,0,.5);
        --sheet-bg:#161618; --sheet-border:#2e2e35; --backdrop: rgba(0,0,0,.5);
      }
      body{ background:#000; }
    }

    html,body{height:100%}
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--sans);
      -webkit-font-smoothing:antialiased; padding: clamp(.75rem, 2vw, 1.25rem); }
    .wrap{ max-width:680px; margin:0 auto; }

    /* Header */
    .header{ display:flex; align-items:center; gap:.75rem; margin-bottom:.75rem; }
    .title{ display:flex; align-items:center; gap:.6rem; flex:1; }
    .title h1{ margin:0; font-size: clamp(1.2rem, 2.2vw, 1.5rem); font-weight:700; letter-spacing:.2px; }
    .iconbtn{
      appearance:none; border:1px solid var(--border); background:var(--control); color:var(--text);
      width:40px; height:40px; border-radius:12px; display:grid; place-items:center; cursor:pointer;
      transition: transform .04s ease, background .2s ease;
    }
    .iconbtn:active{ transform: scale(.97); }
    .iconbtn svg{ width:18px; height:18px; }

    .card{ background:var(--card); border:1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow); padding:1rem; margin:1rem 0; }

    textarea{
      width:100%; min-height:120px; padding:.9rem; border-radius:12px;
      border:1px solid var(--border); background:var(--control); color:var(--text);
      font-family:var(--mono); font-size:1rem; box-sizing:border-box; resize:vertical;
      transition: border-color .2s ease;
    }
    textarea:focus{ outline:none; border-color:#9ec9ff; }

    .toolbar{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }

    .segmented{
      display:inline-flex; border:1px solid var(--border); border-radius:999px; overflow:hidden; background:var(--control);
    }
    .segmented button{
      border:none; padding:.55rem .9rem; background:transparent; color:var(--text); cursor:pointer; font-size:.9rem;
      transition: background .15s ease, transform .04s ease;
    }
    .segmented button:active{ transform: scale(.98); }
    .segmented button.active{ background: var(--chip); }

    .badge{ background:var(--chip); border:1px solid var(--border); padding:.35rem .6rem; border-radius:999px;
      font-variant-numeric:tabular-nums; color:var(--muted); }

    .label-row{ display:flex; align-items:center; justify-content:space-between; margin-bottom:.6rem; }
    .label-row h2{ margin:0; font-size:1.05rem; font-weight:700; }
    .label-row .right{ display:flex; gap:.6rem; align-items:center; }

    pre{
      background:var(--chip); border:1px solid var(--border); color:var(--text);
      border-radius:12px; padding:1rem; white-space:pre-wrap; word-break:break-word;
      font-family:var(--mono); font-size:.98rem; margin:0;
      animation: fadein .18s ease-out;
    }
    @keyframes fadein{ from{opacity:0; transform: translateY(2px);} to{opacity:1; transform:none;} }

    /* Dropdown simple */
    .dropdown{ position:relative; }
    .menu{
      position:absolute; right:0; top:calc(100% + 8px); min-width: 220px;
      background:var(--dropdown); border:1px solid var(--drop-border); border-radius:12px;
      box-shadow: var(--drop-shadow); padding:.4rem; display:none; z-index:20;
    }
    .menu.open{ display:block; animation: pop .12s ease-out; transform-origin: top right; }
    @keyframes pop{ from{opacity:0; transform: scale(.98);} to{opacity:1; transform: scale(1);} }
    .menu button{
      width:100%; background:transparent; border:none; text-align:left;
      display:flex; align-items:center; gap:.6rem; padding:.6rem .6rem; border-radius:10px; color:var(--text); cursor:pointer;
    }
    .menu button:hover{ background: var(--chip); }
    .menu svg{ width:18px; height:18px; color:var(--muted); }

    /* Barra Historial simple */
    .hist-bar{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; }
    .hist-bar h2{ margin:0; font-size:1.05rem; font-weight:700; }
    .hist-open.btn{ padding:.6rem .9rem; border-radius:10px; border:1px solid var(--border); background:var(--control); cursor:pointer; }

    /* Bottom Sheet (draggable con snap points) */
    .sheet{ position:fixed; inset:0; display:none; z-index:50; }
    .sheet.open{ display:block; }
    .sheet__backdrop{
      position:absolute; inset:0; background: var(--backdrop); opacity:0; transition: opacity .2s ease;
    }
    .sheet.open .sheet__backdrop{ opacity:1; }
    .sheet__panel{
      position:absolute; left:50%; bottom:0; transform: translate(-50%, 100%);
      width: min(680px, 100%); background: var(--sheet-bg);
      border-top-left-radius: 16px; border-top-right-radius: 16px;
      border:1px solid var(--sheet-border); border-bottom:none;
      box-shadow: 0 -10px 30px rgba(0,0,0,.18);
      max-height: 80vh; height: 50vh; /* default open height */
      display:flex; flex-direction:column;
      transition: transform .28s cubic-bezier(.2,.8,.2,1);
      will-change: transform;
    }
    .sheet.open .sheet__panel{ transform: translate(-50%, 0%); }
    .sheet__grab{
      width:42px; height:5px; background:#c7c7cc; border-radius:999px; margin:10px auto;
    }
    @media (prefers-color-scheme: dark){ .sheet__grab{ background:#3a3a3c; } }
    .sheet__content{ padding: 0 16px 16px; overflow:auto; }
    .history{ display:flex; flex-direction:column; gap:.5rem; }
    .hist-item{
      display:flex; gap:.5rem; align-items:center; padding:.6rem .75rem; border-radius:10px;
      background:var(--chip); border:1px solid var(--border); cursor:pointer;
    }
    .hist-item small{ color:var(--muted); margin-left:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>Calculadora CAGED</h1>
      </div>

      <!-- Papelera -->
      <button class="iconbtn" id="btnClear" title="Limpar">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M8 6V4h8v2M6 6l1 14a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-14"/>
        </svg>
      </button>

      <!-- Menú ⋯ -->
      <div class="dropdown">
        <button class="iconbtn" id="btnMenu" title="Menú">
          <svg viewBox="0 0 24 24" fill="currentColor"><circle cx="5" cy="12" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="19" cy="12" r="2"/></svg>
        </button>
        <div class="menu" id="menu" role="menu" aria-label="Accións">
          <button id="actCopy">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15V5a2 2 0 0 1 2-2h10"/></svg>
            Copiar saída
          </button>
          <button id="actDownload">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 3v12"/><path d="m7 10 5 5 5-5"/><path d="M5 21h14"/></svg>
            Descargar .txt
          </button>
          <button id="actShare">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"/><path d="M16 6l-4-4-4 4"/><path d="M12 2v14"/></svg>
            Compartir ligazón
          </button>
        </div>
      </div>
    </div>

    <section class="card">
      <label for="input" style="display:block; color:var(--muted); margin-bottom:.4rem;">Progresión (notación latina, admite saltos de liña):</label>
      <textarea id="input" placeholder="ex:\n do sol la- fa"></textarea>
    </section>

    <section class="card">
      <div class="label-row">
        <h2>Saída</h2>
        <div class="right">
          <!-- Notación al lado del título -->
          <div class="segmented" role="tablist" aria-label="Notación">
            <button id="btnLat" class="active" onclick="setNotation('latina')" aria-selected="true">Latina</button>
            <button id="btnEng" onclick="setNotation('inglesa')" aria-selected="false">Inglesa</button>
          </div>
          <!-- Transposición al lado también -->
          <span class="badge" id="tpView">Transposición: +0</span>
          <div class="segmented" aria-label="Transpoñer">
            <button onclick="ajustarTransposicion(-1)">–</button>
            <button onclick="ajustarTransposicion(+1)">+</button>
            <button onclick="resetTP()">Reset</button>
          </div>
        </div>
      </div>
      <pre id="output">Escribe a progresión.</pre>
    </section>

    <section class="card">
      <div class="hist-bar">
        <h2>Historial</h2>
        <button class="hist-open btn" id="openHist">Ver</button>
      </div>
    </section>
  </div>

  <!-- Bottom Sheet Historial (draggable) -->
  <div class="sheet" id="histSheet" aria-hidden="true">
    <div class="sheet__backdrop" id="histBackdrop"></div>
    <div class="sheet__panel" id="histPanel" role="dialog" aria-modal="true" aria-label="Historial recente">
      <div class="sheet__grab" id="histGrab"></div>
      <div class="sheet__content">
        <div class="history" id="history"></div>
      </div>
    </div>
  </div>

<script>
/* ====== Teoría / mapeos ====== */
const CROMA     = ["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"];
const CROMA_LAT = ["do","do#","re","mib","mi","fa","fa#","sol","sol#","la","sib","si"];
const LAT2ENG = {
  "solb":"F#","reb":"C#","lab":"G#","mib":"Eb","sib":"Bb",
  "do#":"C#","re#":"Eb","fa#":"F#","sol#":"G#","la#":"Bb",
  "do":"C","re":"D","mi":"E","fa":"F","sol":"G","la":"A","si":"B"
};
const ENG2LAT = Object.fromEntries(CROMA.map((n,i)=>[n, CROMA_LAT[i]]));
const NORMALIZE = {"B#":"C","E#":"F","Cb":"B","Fb":"E","C##":"D","F##":"G","G##":"A","D##":"E","A##":"B",
                   "Bb#":"B","Eb#":"E","Ab#":"A","Db#":"D","Gb#":"G"};

/* ====== Estado ====== */
let TP = 0;                 // –12..+12
let NOTATION = 'latina';    // 'latina' | 'inglesa'
const $ = s => document.querySelector(s);

/* ====== Utils ====== */
function normalizar(nota){
  for (let raro in NORMALIZE){ if (nota.startsWith(raro)) return nota.replace(raro,NORMALIZE[raro]); }
  return nota;
}
function traducirLat2Eng(token){
  const s = token.toLowerCase();
  const keys = Object.keys(LAT2ENG).sort((a,b)=>b.length-a.length);
  for (let k of keys){ if (s.startsWith(k)) return LAT2ENG[k] + token.slice(k.length); }
  return token;
}
function detectarRaiz(acorde){
  const MATCH = [...CROMA].sort((a,b)=>b.length-a.length);
  for (let n of MATCH){ if (acorde.startsWith(n)) return [n, acorde.slice(n.length)]; }
  return [null, acorde];
}
function transponerToken(acorde, semi){
  const [raiz, resto] = detectarRaiz(acorde);
  if (!raiz) return acorde;
  const i = CROMA.indexOf(raiz);
  const nova = CROMA[(i + semi + 1200) % 12];
  return normalizar(nova + resto);
}
function offsetsCejillas(tonica){
  const idx = CROMA.indexOf(tonica);
  const refs = {"C":"C","A":"A","G":"G","E":"E","D":"D"};
  const out = {};
  for (let f in refs){
    const idxRef = CROMA.indexOf(refs[f]);
    out[f] = { offset:(idxRef - idx + 12) % 12, cejilla:(idx - idxRef + 12) % 12 };
  }
  return out;
}
function capFirst(s){ return s ? s[0].toUpperCase() + s.slice(1) : s; }
function aLatina(acorde){
  const [r, resto] = detectarRaiz(acorde);
  if (!r) return acorde;
  return capFirst(ENG2LAT[r] || r) + resto;
}
function debounce(fn, wait=220){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

/* ====== Motor (orden por traste de cejilla) ====== */
function procesar(){
  const raw = $('#input').value.trim();
  if (!raw){
    $('#output').textContent = 'Escribe a progresión.';
    actualizarURL(); gardarEstado(); renderHistorial();
    $('#tpView').textContent = `Transposición: ${TP>=0?`+${TP}`:TP}`;
    return;
  }
  const lineasEng = raw.split('\n').map(l => l.trim().split(/\s+/).map(traducirLat2Eng));
  const lineasTransp = lineasEng.map(tokens => tokens.map(t => transponerToken(t, TP)));
  const tonica = lineasTransp[0][0];
  const offCej = offsetsCejillas(tonica);

  const formasOrdenadas = Object.entries(offCej)
    .map(([forma, data]) => ({ forma, ...data }))
    .sort((a,b)=> a.cejilla - b.cejilla);

  let out = `Progresión orixinal:\n${raw}\n\nTransposición: ${TP>=0?`+${TP}`:TP} semitonos\n\n--- Posiciones CAGED (orden por traste) ---\n`;
  for (let item of formasOrdenadas){
    const {forma, offset, cejilla} = item;
    out += `\nForma ${forma} (cejilla traste ${cejilla}):\n`;
    for (let linea of lineasTransp){
      let acordes = linea.map(a => transponerToken(a, offset));
      if (NOTATION === 'latina') acordes = acordes.map(aLatina);
      out += acordes.join(' ') + '\n';
    }
  }
  $('#output').textContent = out;
  $('#tpView').textContent = `Transposición: ${TP>=0?`+${TP}`:TP}`;

  actualizarURL(); gardarEstado(); pushHistorial(raw, NOTATION, TP);
}

/* ====== Persistencia / permalink / historial ====== */
const LS_KEY = 'caged_state_sheet_v2';
const LS_HIST = 'caged_hist_sheet_v2';

function gardarEstado(){
  const data = { p: $('#input').value.trim(), n: NOTATION, tp: TP };
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function cargarEstado(){
  const q = new URLSearchParams(location.search);
  let p = q.get('p'), n = q.get('n'), tp = q.get('tp');
  if (p) $('#input').value = decodeURIComponent(p);
  if (n) NOTATION = (n==='inglesa'?'inglesa':'latina');
  if (tp) TP = Math.max(-12, Math.min(12, parseInt(tp,10)||0));
  if (!p){
    try{
      const s = JSON.parse(localStorage.getItem(LS_KEY)||'{}');
      if (s.p) $('#input').value = s.p;
      if (s.n) NOTATION = s.n;
      if (typeof s.tp === 'number') TP = Math.max(-12, Math.min(12, s.tp));
    }catch(e){}
  }
  updateNotationUI();
  $('#tpView').textContent = `Transposición: ${TP>=0?`+${TP}`:TP}`;
}
function actualizarURL(){
  const p = encodeURIComponent($('#input').value.trim());
  const n = NOTATION;
  const tp = TP;
  history.replaceState(null,'', `${location.pathname}?p=${p}&n=${n}&tp=${tp}`);
}
function getHist(){ try{ return JSON.parse(localStorage.getItem(LS_HIST)||'[]'); }catch(e){ return []; } }
function setHist(a){ localStorage.setItem(LS_HIST, JSON.stringify(a)); }
function pushHistorial(p,n,tp){
  if (!p) return;
  let arr = getHist();
  if (arr[0] && arr[0].p===p && arr[0].n===n && arr[0].tp===tp) return;
  arr.unshift({p,n,tp,ts:Date.now()});
  if (arr.length>10) arr = arr.slice(0,10);
  setHist(arr); // render en open
}

/* ====== Notación UI ====== */
function setNotation(n){
  NOTATION = n==='inglesa' ? 'inglesa' : 'latina';
  updateNotationUI(); procesar();
}
function updateNotationUI(){
  $('#btnLat').classList.toggle('active', NOTATION==='latina');
  $('#btnEng').classList.toggle('active', NOTATION==='inglesa');
  $('#btnLat').setAttribute('aria-selected', NOTATION==='latina');
  $('#btnEng').setAttribute('aria-selected', NOTATION==='inglesa');
}

/* ====== Handlers ====== */
const doProcesar = debounce(procesar, 220);
$('#input').addEventListener('input', doProcesar);

/* Papelera */
$('#btnClear').addEventListener('click', ()=>{ $('#input').value=''; NOTATION='latina'; TP=0; updateNotationUI(); procesar(); });

/* Menú ⋯ */
const menu = $('#menu');
$('#btnMenu').addEventListener('click', (e)=>{ e.stopPropagation(); menu.classList.toggle('open'); });
document.addEventListener('click', (e)=>{ if (!menu.contains(e.target) && e.target !== $('#btnMenu')) menu.classList.remove('open'); });

$('#actCopy').addEventListener('click', async ()=>{
  try{ await navigator.clipboard.writeText($('#output').textContent||''); }catch(e){}
  menu.classList.remove('open');
});
$('#actDownload').addEventListener('click', ()=>{
  const text = $('#output').textContent||'';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([text],{type:'text/plain'}));
  a.download = 'caged.txt'; a.click(); URL.revokeObjectURL(a.href);
  menu.classList.remove('open');
});
$('#actShare').addEventListener('click', async ()=>{
  const url = location.href;
  if (navigator.share){ try{ await navigator.share({title:'CAGED', url}); }catch(e){} }
  else { try{ await navigator.clipboard.writeText(url); alert('Ligazón copiada.'); }catch(e){} }
  menu.classList.remove('open');
});

/* Transposición */
function ajustarTransposicion(d){ TP = Math.max(-12, Math.min(12, TP + d)); procesar(); }
function resetTP(){ TP=0; procesar(); }

/* ====== Bottom Sheet – Historial con drag ====== */
const sheet = $('#histSheet'), backdrop = $('#histBackdrop'), panel = $('#histPanel'), grab = $('#histGrab');
const SNAP = [0.25, 0.5, 0.8]; // ratios de alto
let startY=0, startH=0, dragging=false;

function setPanelHeightByRatio(r){
  r = Math.max(0.2, Math.min(0.92, r));
  panel.style.height = `${r*100}vh`;
}
function getPanelRatio(){
  const h = panel.getBoundingClientRect().height;
  return h / window.innerHeight;
}
function openHist(){
  renderHistorial(); // llena contenido
  setPanelHeightByRatio(0.5); // abre a 50%
  sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';
  // asegura posición visible (slide up animado por CSS)
}
function closeHist(){
  sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); document.body.style.overflow='';
}
$('#openHist').addEventListener('click', openHist);
backdrop.addEventListener('click', closeHist);
window.addEventListener('keydown', (e)=>{ if (e.key==='Escape' && sheet.classList.contains('open')) closeHist(); });

// Drag (touch + mouse)
function onStart(e){
  dragging = true;
  startY = (e.touches? e.touches[0].clientY : e.clientY);
  startH = panel.getBoundingClientRect().height;
  panel.style.transition = 'none';
}
function onMove(e){
  if (!dragging) return;
  const y = (e.touches? e.touches[0].clientY : e.clientY);
  const dy = startY - y; // arrastrar hacia arriba => positivo
  const newH = startH + dy;
  const ratio = newH / window.innerHeight;
  setPanelHeightByRatio(ratio);
}
function onEnd(){
  if (!dragging) return;
  dragging = false;
  panel.style.transition = ''; // vuelve animación para snaps
  const r = getPanelRatio();
  // si está muy abajo, cerrar
  if (r < 0.22){ closeHist(); return; }
  // snap al más cercano
  let nearest = SNAP[0]; let best = Infinity;
  for (let s of SNAP){ const diff = Math.abs(s - r); if (diff < best){ best = diff; nearest = s; } }
  setPanelHeightByRatio(nearest);
}
grab.addEventListener('mousedown', onStart);
window.addEventListener('mousemove', onMove);
window.addEventListener('mouseup', onEnd);
grab.addEventListener('touchstart', onStart, {passive:true});
window.addEventListener('touchmove', onMove, {passive:false});
window.addEventListener('touchend', onEnd);

/* Render historial dentro del sheet */
function renderHistorial(){
  const box = $('#history'); if (!box) return;
  const arr = getHist(); box.innerHTML='';
  if (!arr.length){ box.innerHTML = `<div style="color:var(--muted); padding:.5rem 0;">Sen entradas recentes.</div>`; return; }
  arr.forEach(item=>{
    const div = document.createElement('div');
    div.className='hist-item';
    div.innerHTML = `<span>${item.p.replace(/\n/g,' · ')}</span><small>${item.n} · ${item.tp>=0?`+${item.tp}`:item.tp}</small>`;
    div.onclick = ()=>{ $('#input').value=item.p; NOTATION=item.n; TP=item.tp; updateNotationUI(); procesar(); closeHist(); };
    box.appendChild(div);
  });
}

/* ====== Boot + PWA ====== */
cargarEstado(); procesar();
if ('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js') ); }
</script>
</body>
</html>
