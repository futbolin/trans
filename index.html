<!DOCTYPE html>
<html lang="gl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Calculadora CAGED</title>
  <style>
    :root {
      --bg:#f2f2f7; --card:#fff; --text:#1c1c1e; --sub:#6e6e73; --accent:#007aff;
      --radius:12px; --shadow:0 2px 8px rgba(0,0,0,.1);
    }
    body { margin:0; padding:1rem; background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Roboto,sans-serif; color:var(--text); }
    h1 { text-align:center; margin:.25rem 0 0; font-size:1.5rem; font-weight:700; }
    .card { background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:1rem; margin:1rem 0; }
    textarea { width:100%; min-height:120px; font-family:monospace; font-size:1rem;
      padding:.8rem; border:1px solid #d1d1d6; border-radius:var(--radius); box-sizing:border-box; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    button, select { border:none; border-radius:10px; padding:.8rem 1rem; font-size:1rem; }
    button.primary { background:var(--accent); color:#fff; font-weight:600; flex:1; }
    button.ghost { background:#e5e5ea; color:#111; }
    .pill { background:#e5e5ea; border-radius:999px; padding:.35rem .75rem; font-variant-numeric:tabular-nums; }
    pre { background:#f2f2f7; padding:1rem; border-radius:var(--radius); white-space:pre-wrap; word-break:break-word; }
    @media (max-width:600px){ button.primary{flex-basis:100%} }
  </style>
</head>
<body>
  <h1>Calculadora CAGED</h1>

  <div class="card">
    <label for="input" style="display:block;color:var(--sub);margin-bottom:.4rem;">Progresión (notación latina, admite saltos de liña):</label>
    <textarea id="input" placeholder="ex:\n do sol la- fa"></textarea>

    <div class="row" style="margin-top:.75rem;">
      <button class="primary" onclick="procesar()">Calcular</button>
      <select id="notation" onchange="procesar()">
        <option value="latina" selected>Notación: Latina (do, fa#, sib…)</option>
        <option value="inglesa">Notación: Inglesa (C, F#, Bb…)</option>
      </select>
    </div>

    <div class="row" style="margin-top:.5rem;">
      <span class="pill">Transposición: <span id="tpLabel">0</span></span>
      <div style="display:flex; gap:.5rem; margin-left:auto;">
        <button class="ghost" onclick="ajustarTransposicion(-1)">–</button>
        <button class="ghost" onclick="ajustarTransposicion(+1)">+</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:.2rem 0 1rem; font-size:1.2rem;">Saída</h2>
    <div id="output"><pre>Escribe a progresión e preme “Calcular”.</pre></div>
  </div>

<script>
/* --------- Teoría / mapeos --------- */
const CROMA      = ["C","C#","D","Eb","E","F","F#","G","G#","A","Bb","B"];
const CROMA_LAT  = ["do","do#","re","mib","mi","fa","fa#","sol","sol#","la","sib","si"];
const LAT2ENG = {
  "solb":"F#","reb":"C#","lab":"G#","mib":"Eb","sib":"Bb",
  "do#":"C#","re#":"Eb","fa#":"F#","sol#":"G#","la#":"Bb",
  "do":"C","re":"D","mi":"E","fa":"F","sol":"G","la":"A","si":"B"
};
const ENG2LAT = Object.fromEntries(CROMA.map((n,i)=>[n, CROMA_LAT[i]]));
const NORMALIZE = {"B#":"C","E#":"F","Cb":"B","Fb":"E","C##":"D","F##":"G","G##":"A","D##":"E","A##":"B",
                   "Bb#":"B","Eb#":"E","Ab#":"A","Db#":"D","Gb#":"G"};
/* estado de transposición global (en semitonos) */
let TP = 0;

function normalizar(nota){
  for (let raro in NORMALIZE){
    if (nota.startsWith(raro)) return nota.replace(raro, NORMALIZE[raro]);
  }
  return nota;
}
function traducirLat2Eng(token){
  const s = token.toLowerCase();
  const keys = Object.keys(LAT2ENG).sort((a,b)=>b.length-a.length);
  for (let k of keys){
    if (s.startsWith(k)) return LAT2ENG[k] + token.slice(k.length);
  }
  return token; // xa en inglesa
}
function detectarRaiz(acorde){
  const MATCH = [...CROMA].sort((a,b)=>b.length-a.length);
  for (let n of MATCH){
    if (acorde.startsWith(n)) return [n, acorde.slice(n.length)];
  }
  return [null, acorde];
}
function transponerToken(acorde, semi){
  const [raiz, resto] = detectarRaiz(acorde);
  if (!raiz) return acorde;
  const i = CROMA.indexOf(raiz);
  const nova = CROMA[(i + semi + 1200) % 12];
  return normalizar(nova + resto);
}
function offsetsCejillas(tonica){
  const idx  = CROMA.indexOf(tonica);
  const refs = {"C":"C","A":"A","G":"G","E":"E","D":"D"};
  const out  = {};
  for (let f in refs){
    const idxRef = CROMA.indexOf(refs[f]);
    out[f] = { offset: (idxRef - idx + 12) % 12, cejilla: (idx - idxRef + 12) % 12 };
  }
  return out;
}
function aLatina(acorde){
  const [r, resto] = detectarRaiz(acorde);
  if (!r) return acorde;
  return (ENG2LAT[r] || r) + resto;
}

/* --------- Motor principal (con transposición TP) --------- */
function procesar(){
  const raw = document.getElementById('input').value.trim();
  if (!raw){
    document.getElementById('output').innerHTML = '<pre>Escribe a progresión e preme “Calcular”.</pre>';
    return;
  }
  const modo = document.getElementById('notation').value;

  // 1) traducir entrada latina -> inglesa
  const lineasEng = raw.split('\n').map(l => l.trim().split(/\s+/).map(traducirLat2Eng));

  // 2) aplicar transposición global TP á progresión antes de calcular CAGED
  const lineasTransp = lineasEng.map(tokens => tokens.map(t => transponerToken(t, TP)));

  // 3) tonica efectiva = primeiro acorde despois de transpoñer
  const tonica = lineasTransp[0][0];
  const offCej = offsetsCejillas(tonica);

  // 4) xerar saída por formas
  let out = `Progresión orixinal:\n${raw}\n\nTransposición: ${TP >= 0 ? '+'+TP : TP} semitonos\n\n--- Posiciones CAGED ---\n`;
  for (let forma of ["C","A","G","E","D"]){
    const {offset, cejilla} = offCej[forma];
    out += `\nForma ${forma} (cejilla traste ${cejilla}):\n`;
    for (let linea of lineasTransp){
      // sobre a progresión xa transposta, aplico o offset da forma (shapes “ao aire”)
      let acordes = linea.map(a => transponerToken(a, offset));
      if (modo === 'latina') acordes = acordes.map(aLatina);
      out += acordes.join(' ') + '\n';
    }
  }
  document.getElementById('output').innerHTML = `<pre>${out}</pre>`;
  document.getElementById('tpLabel').textContent = TP >= 0 ? `+${TP}` : `${TP}`;
}

function ajustarTransposicion(delta){
  TP = ((TP + delta) % 12 + 12) % 12; // manter en 0..11
  procesar();
}

/* opcional: recalcular ao cambiar notación */
document.getElementById('notation').addEventListener('change', procesar);
</script>
</body>
</html>
